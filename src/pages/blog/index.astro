---
import BaseLayout from "../../layouts/BaseLayout.astro";
import SearchBar from "../../components/SearchBar";
import { db } from "../../db";
import { posts } from "../../db/schema";
import { eq } from "drizzle-orm";

const isAdmin = Astro.locals.isAdmin;
const allPosts = isAdmin
  ? await db.select().from(posts).orderBy(posts.sortOrder).all()
  : await db.select().from(posts).where(eq(posts.visible, true)).orderBy(posts.sortOrder).all();
---

<BaseLayout title="Journal — Gabriel">
  <div class="blog-list">
    <div class="blog-header">
      <div>
        <h1 class="blog-title">Journal<span class="dot">.</span></h1>
        <p class="blog-subtitle">Notes techniques et retours d'expérience.</p>
      </div>
      <SearchBar
        client:visible
        posts={allPosts.map((p) => ({
          id: p.id,
          title: p.title,
          excerpt: p.excerpt,
          cat: p.cat,
          visible: p.visible,
        }))}
      />
    </div>

    <p id="no-results" class="no-results" style="display: none;">
      Aucun article trouvé.
    </p>

    {allPosts.map((p) => (
      <article class:list={["blog-article", { hidden: !p.visible }]} data-post-id={p.id}>
        <a href={`/blog/${p.id}`} class="article-link">
          <div class="article-meta">
            <span class="article-cat">{p.cat}</span>
            <span class="meta-dot" />
            <span class="article-date">{p.date}</span>
            {!p.visible && <span class="hidden-badge">masqué</span>}
          </div>
          <h2 class="article-title">{p.title}</h2>
          <p class="article-excerpt">{p.excerpt}</p>
          <span class="article-time">{p.time} →</span>
        </a>
      </article>
    ))}
  </div>
</BaseLayout>

<style>
  .blog-list {
    max-width: 1100px;
    width: 100%;
    margin: 0 auto;
    padding: 6rem 3rem 8rem;
  }

  .blog-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 4rem;
  }

  .blog-title {
    font-family: 'Playfair Display', serif;
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    color: var(--white);
  }

  .dot {
    color: var(--blue);
  }

  .blog-subtitle {
    font-family: 'DM Sans', sans-serif;
    color: var(--secondary);
    font-size: 1rem;
  }

  .no-results {
    font-family: 'DM Sans', sans-serif;
    color: var(--tertiary);
    font-size: 0.95rem;
  }

  .blog-article {
    margin-bottom: 4rem;
    padding-bottom: 4rem;
    border-bottom: 1px solid var(--line);
  }

  .article-link {
    text-decoration: none;
    cursor: pointer;
    display: block;
  }

  .article-meta {
    display: flex;
    gap: 1rem;
    align-items: center;
    margin-bottom: 1rem;
  }

  .article-cat {
    font-family: 'DM Sans', sans-serif;
    font-size: 0.78rem;
    color: var(--blue);
    font-weight: 500;
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .meta-dot {
    width: 4px;
    height: 4px;
    border-radius: 50%;
    background: var(--tertiary);
  }

  .article-date {
    font-family: 'DM Sans', sans-serif;
    font-size: 0.82rem;
    color: var(--tertiary);
  }

  .blog-article.hidden .article-title {
    color: var(--tertiary);
  }

  .blog-article.hidden .article-excerpt {
    color: var(--tertiary);
  }

  .hidden-badge {
    font-family: 'DM Sans', sans-serif;
    font-size: 0.68rem;
    color: var(--tertiary);
    border: 1px solid var(--line);
    padding: 0.1rem 0.5rem;
    border-radius: 3px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .article-title {
    font-family: 'Playfair Display', serif;
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.8rem;
    color: var(--white);
    transition: color 0.3s;
    line-height: 1.3;
  }

  .article-link:hover .article-title {
    color: var(--blue-hover);
  }

  .article-excerpt {
    font-family: 'DM Sans', sans-serif;
    color: var(--secondary);
    font-size: 1rem;
    line-height: 1.8;
  }

  .article-time {
    font-family: 'DM Sans', sans-serif;
    font-size: 0.82rem;
    color: var(--tertiary);
    margin-top: 0.8rem;
    display: inline-block;
  }
</style>