---
import { db } from "../../../db";
import { docs, sections, projects } from "../../../db/schema";
import { eq } from "drizzle-orm";

const { project } = Astro.params;

const proj = await db
  .select({ id: projects.id })
  .from(projects)
  .where(eq(projects.name, project!))
  .get();

if (!proj) return Astro.redirect("/docs");

const firstDoc = await db
  .select({ id: docs.id })
  .from(docs)
  .innerJoin(sections, eq(docs.sectionId, sections.id))
  .where(eq(sections.projectId, proj.id))
  .orderBy(sections.sortOrder, docs.sortOrder)
  .get();

if (firstDoc) {
  return Astro.redirect(`/docs/${project}/${firstDoc.id}`);
}

return Astro.redirect("/docs");
---