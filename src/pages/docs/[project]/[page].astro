---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import AdminBar from "../../../components/AdminBar.astro";
import EditButton from "../../../components/EditButton.astro";
import Icon from "../../../components/Icon.astro";
import MermaidInit from "../../../components/MermaidInit.astro";
import { db } from "../../../db";
import { docs, sections, projects } from "../../../db/schema";
import { eq, and } from "drizzle-orm";
import { renderMarkdown, extractTOC } from "../../../lib/markdown";

const isAdmin = Astro.locals.isAdmin;
const { project, page: pageSlug } = Astro.params;

// Resolve project
const proj = await db.select().from(projects).where(eq(projects.name, project!)).get();
if (!proj) return Astro.redirect("/docs");

// All docs for this project with section info
const allRows = await db
  .select({
    id: docs.id,
    sectionId: docs.sectionId,
    section: sections.name,
    sectionSort: sections.sortOrder,
    title: docs.title,
    content: docs.content,
    draft: docs.draft,
    visible: docs.visible,
    sortOrder: docs.sortOrder,
  })
  .from(docs)
  .innerJoin(sections, eq(docs.sectionId, sections.id))
  .where(eq(sections.projectId, proj.id))
  .all();

const projectDocs = isAdmin ? allRows : allRows.filter((d) => d.visible);

if (projectDocs.length === 0) {
  return Astro.redirect("/docs");
}

// Active doc
const activeDoc = projectDocs.find((d) => d.id === pageSlug);
if (!activeDoc) {
  return Astro.redirect(`/docs/${project}/${projectDocs[0].id}`);
}

// Build sections ordered by sections.sortOrder
const sectionMap = new Map<string, typeof projectDocs>();
const sectionSortMap = new Map<string, number>();
for (const d of projectDocs) {
  const items = sectionMap.get(d.section) || [];
  items.push(d);
  sectionMap.set(d.section, items);
  sectionSortMap.set(d.section, d.sectionSort);
}

const orderedSections = [...sectionMap.entries()]
  .sort((a, b) => (sectionSortMap.get(a[0]) ?? 0) - (sectionSortMap.get(b[0]) ?? 0))
  .map(([title, items]) => ({
    title,
    items: items.sort((a, b) => a.sortOrder - b.sortOrder),
  }));

const displayContent = isAdmin && activeDoc.draft ? activeDoc.draft : activeDoc.content;
const contentHtml = await renderMarkdown(displayContent);
const toc = extractTOC(displayContent);

// First doc of the project (for breadcrumb project link — avoids 3xx redirect)
const projectFirstDoc = projectDocs.sort((a, b) => a.sectionSort - b.sectionSort || a.sortOrder - b.sortOrder)[0];
// First doc in the active section (for breadcrumb link)
const sectionFirstDoc = projectDocs.find((d) => d.section === activeDoc.section);

const base = Astro.site?.href.replace(/\/$/, "") || "https://gabriel-guillou.fr";
const breadcrumbLd = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Documentation", item: `${base}/docs` },
    { "@type": "ListItem", position: 2, name: proj.displayName || proj.name, item: `${base}/docs/${project}/${projectFirstDoc.id}` },
    { "@type": "ListItem", position: 3, name: activeDoc.title, item: `${base}/docs/${project}/${activeDoc.id}` },
  ],
});
---

<BaseLayout title={`${activeDoc.title} — Documentation ${proj.displayName || proj.name}`} description={`${activeDoc.title} — Documentation technique du projet ${proj.displayName || proj.name}. Guide et référence par Gabriel Guillou.`} ogImage={`/api/og?title=${encodeURIComponent(activeDoc.title)}&cat=${encodeURIComponent("Documentation " + (proj.displayName || proj.name))}`} fullHeight>
  <div class="docs-reader">
    <!-- Left sidebar -->
    <aside class="sidebar">
      <a href="/docs" class="back-link"><Icon name="arrow-left" size={14} /> Tous les projets</a>
      <div class="sidebar-title">{proj.displayName || proj.name}</div>
      {orderedSections.map((s) => (
        <div class="sidebar-section">
          <div class="section-title">{s.title}</div>
          {s.items.map((item) => (
            <a
              href={`/docs/${project}/${item.id}`}
              class:list={["sidebar-item", { active: item.id === activeDoc.id, hidden: !item.visible }]}
            >
              {item.title}
              {!item.visible && <span class="hidden-badge">masqué</span>}
            </a>
          ))}
        </div>
      ))}
    </aside>

    <!-- Mobile sidebar toggle -->
    <button class="sidebar-toggle" id="sidebar-toggle"><Icon name="menu" size={16} /> Navigation</button>

    <!-- Sidebar overlay (mobile) -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- Main content -->
    <div class="doc-content">
      <div class="breadcrumb">
        <a href={`/docs/${project}/${projectFirstDoc.id}`} class="bc-item bc-link">{proj.displayName || proj.name}</a>
        <Icon name="chevron-right" size={12} class="bc-sep" />
        <a href={`/docs/${project}/${sectionFirstDoc?.id ?? pageSlug}`} class="bc-item bc-link">{activeDoc.section}</a>
        <Icon name="chevron-right" size={12} class="bc-sep" />
        <span class="bc-item bc-active">{activeDoc.title}</span>
      </div>
      <h1 class="doc-title">{activeDoc.title}<span class="dot">.</span></h1>
      <div class="md-body" set:html={contentHtml} />
      {isAdmin && (
        <AdminBar
          hasDraft={!!activeDoc.draft}
          publishUrl={`/api/docs/${activeDoc.id}/publish`}
        />
      )}
    </div>

    <!-- Right TOC -->
    <nav class="toc-sidebar" aria-label="Sur cette page">
      <div class="toc-title">Sur cette page</div>
      {toc.map((t, i) => (
        <a href={`#${t.slug}`} class:list={["toc-item", { active: i === 0 }]}>{t.text}</a>
      ))}
    </nav>
  </div>
  {isAdmin && <EditButton href={`/admin/docs-edit?id=${activeDoc.id}`} />}
  <MermaidInit />
  <script type="application/ld+json" set:html={breadcrumbLd} />
</BaseLayout>

<script is:inline>
  (function() {
    const toggle = document.getElementById("sidebar-toggle");
    const sidebar = document.querySelector(".sidebar");
    const overlay = document.getElementById("sidebar-overlay");
    if (!toggle || !sidebar || !overlay) return;

    function openSidebar() {
      sidebar.classList.add("open");
      overlay.classList.add("open");
      document.body.style.overflow = "hidden";
    }

    function closeSidebar() {
      sidebar.classList.remove("open");
      overlay.classList.remove("open");
      document.body.style.overflow = "";
    }

    toggle.addEventListener("click", openSidebar);
    overlay.addEventListener("click", closeSidebar);

    // Close on link click
    sidebar.querySelectorAll("a").forEach((link) => {
      link.addEventListener("click", closeSidebar);
    });
  })();
</script>

<style>
  .docs-reader {
    display: grid;
    grid-template-columns: 250px 1fr 170px;
    flex: 1;
    overflow: hidden;
  }

  /* ─── Left sidebar ─── */
  .sidebar {
    padding: 1.5rem 1.2rem 1.5rem 3rem;
    border-right: 1px solid var(--line);
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }

  .back-link {
    background: none;
    border: none;
    color: var(--tertiary);
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-size: var(--fs-xs);
    margin-bottom: 1rem;
    text-align: left;
    padding: 0;
    text-decoration: none;
    transition: color 0.2s;
  }

  .back-link:hover {
    color: var(--blue-hover);
  }

  .sidebar-title {
    font-family: 'Source Serif 4', serif;
    font-size: var(--fs-h3);
    font-weight: 600;
    color: var(--white);
    margin-bottom: 1rem;
  }

  .sidebar-section {
    margin-bottom: 1.5rem;
  }

  .section-title {
    font-family: 'Source Serif 4', serif;
    font-size: var(--fs-sm);
    color: var(--white);
    margin-bottom: 0.5rem;
    font-weight: 600;
  }

  .sidebar-item {
    display: block;
    padding: 0.3rem 0;
    padding-left: 0.8rem;
    cursor: pointer;
    font-size: var(--fs-sm);
    font-family: 'DM Sans', sans-serif;
    color: var(--tertiary);
    font-weight: 400;
    border-left: 2px solid transparent;
    transition: color 0.2s, border-color 0.2s;
    text-decoration: none;
  }

  .sidebar-item:hover {
    color: var(--blue-hover);
  }

  .sidebar-item.active {
    color: var(--blue-hover);
    font-weight: 500;
    border-left-color: var(--blue);
  }

  .sidebar-item.hidden {
    color: var(--decorative);
    font-style: italic;
  }

  .hidden-badge {
    font-size: var(--fs-xxs);
    color: var(--tertiary);
    border: 1px solid var(--line);
    padding: 0 0.4rem;
    border-radius: 3px;
    margin-left: 0.3rem;
    vertical-align: middle;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* ─── Main content ─── */
  .doc-content {
    padding: 3rem 3.5rem 6rem;
    overflow-y: auto;
  }

  .breadcrumb {
    display: flex;
    align-items: center;
    gap: 0.3rem;
    margin-bottom: 2.5rem;
    font-family: 'DM Sans', sans-serif;
    font-size: var(--fs-xs);
  }

  .bc-item {
    color: var(--tertiary);
  }

  .bc-link {
    text-decoration: none;
    transition: color 0.2s;
  }

  .bc-link:hover {
    color: var(--blue-hover);
  }

  .bc-active {
    color: var(--blue-hover);
  }

  .bc-sep {
    color: var(--line);
    margin: 0 0.4rem;
  }

  .doc-title {
    font-family: 'Source Serif 4', serif;
    font-size: var(--fs-h1);
    font-weight: 700;
    margin-bottom: 2rem;
    color: var(--white);
  }

  .dot {
    color: var(--blue);
  }

  /* ─── Right TOC ─── */
  .toc-sidebar {
    border-left: 1px solid var(--line);
    padding: 3rem 3rem 3rem 1.2rem;
    overflow-y: auto;
    text-align: right;
  }

  .toc-title {
    font-family: 'DM Sans', sans-serif;
    font-size: var(--fs-xxs);
    color: var(--tertiary);
    letter-spacing: 1.5px;
    margin-bottom: 1rem;
    text-transform: uppercase;
    font-weight: 500;
  }

  .toc-item {
    display: block;
    font-size: var(--fs-sm);
    color: var(--tertiary);
    margin-bottom: 0.6rem;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    padding-right: 0.8rem;
    border-right: 1px solid transparent;
    text-decoration: none;
    transition: color 0.2s;
  }

  .toc-item:hover {
    color: var(--blue-hover);
  }

  .toc-item.active {
    color: var(--blue-hover);
    border-right-color: var(--blue);
  }

  /* md-body styles are in global.css — only override font-size for docs */
  .md-body {
    font-size: var(--fs-body);
  }

  /* ─── Sidebar toggle (hidden by default) ─── */
  .sidebar-toggle {
    display: none;
    background: var(--surface);
    border: 1px solid var(--line);
    color: var(--tertiary);
    padding: 0.5rem 1rem;
    align-items: center;
    gap: 0.4rem;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-size: var(--fs-sm);
    border-radius: 6px;
    margin: 1rem 1.2rem 0;
    transition: color 0.2s, border-color 0.2s;
  }

  .sidebar-toggle:hover {
    border-color: var(--blue);
    color: var(--blue-hover);
  }

  .sidebar-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 90;
  }

  .sidebar-overlay.open {
    display: block;
  }

  /* ─── Nav breakpoint: align sidebars with nav padding ─── */
  @media (max-width: 1280px) {
    .sidebar {
      padding-left: 1.2rem;
    }

    .toc-sidebar {
      padding-right: 1.2rem;
    }
  }

  /* ─── Tablet: hide TOC, 2 columns ─── */
  @media (max-width: 1024px) {
    .docs-reader {
      grid-template-columns: 220px 1fr;
    }

    .sidebar {
      padding-left: 1.5rem;
    }

    .toc-sidebar {
      display: none;
    }

    .doc-content {
      padding: 2rem 2rem 4rem;
    }
  }

  /* ─── Mobile: single column, sidebar as overlay ─── */
  @media (max-width: 768px) {
    .docs-reader {
      display: flex;
      flex-direction: column;
      overflow: visible;
    }

    .sidebar {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 91;
      background: var(--bg);
      padding: 1.5rem 1.2rem;
      overflow-y: auto;
    }

    .sidebar.open {
      display: flex;
    }

    .sidebar-toggle {
      display: flex;
      margin-top: 1.5rem;
    }

    .doc-content {
      padding: 1rem 1.2rem 4rem;
    }
  }
</style>