---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import AdminBar from "../../../components/AdminBar.astro";
import EditButton from "../../../components/EditButton.astro";
import MermaidInit from "../../../components/MermaidInit.astro";
import DocSearch from "../../../components/DocSearch";
import { db } from "../../../db";
import { docs, settings } from "../../../db/schema";
import { DOC_SECTIONS_ORDER } from "../../../db/schema";
import { eq, and } from "drizzle-orm";
import { renderMarkdown, extractTOC } from "../../../lib/markdown";

const isAdmin = Astro.locals.isAdmin;
const { project, page: pageSlug } = Astro.params;

// All visible docs for this project (admin sees all)
const projectDocs = isAdmin
  ? await db.select().from(docs).where(eq(docs.project, project!)).all()
  : await db.select().from(docs).where(and(eq(docs.project, project!), eq(docs.visible, true))).all();

if (projectDocs.length === 0) {
  return Astro.redirect("/docs");
}

// Active doc
const activeDoc = projectDocs.find((d) => d.id === pageSlug);
if (!activeDoc) {
  return Astro.redirect(`/docs/${project}/${projectDocs[0].id}`);
}

// Read section order from settings (fallback to DOC_SECTIONS_ORDER)
const sectionOrderRow = await db
  .select()
  .from(settings)
  .where(eq(settings.key, `section-order:${project}`))
  .get();
const sectionOrder: string[] = sectionOrderRow
  ? JSON.parse(sectionOrderRow.value)
  : DOC_SECTIONS_ORDER;

// Build sections ordered by sectionOrder
const sectionMap = new Map<string, typeof projectDocs>();
for (const d of projectDocs) {
  const items = sectionMap.get(d.section) || [];
  items.push(d);
  sectionMap.set(d.section, items);
}

const orderedSections: Array<{ title: string; items: typeof projectDocs }> = [];
for (const title of sectionOrder) {
  const items = sectionMap.get(title);
  if (items && items.length > 0) {
    orderedSections.push({ title, items: items.sort((a, b) => a.sortOrder - b.sortOrder) });
    sectionMap.delete(title);
  }
}
// Remaining sections not in the predefined order
for (const [title, items] of sectionMap) {
  orderedSections.push({ title, items: items.sort((a, b) => a.sortOrder - b.sortOrder) });
}

const displayContent = isAdmin && activeDoc.draft ? activeDoc.draft : activeDoc.content;
const contentHtml = await renderMarkdown(displayContent);
const toc = extractTOC(displayContent);

// First doc in the active section (for breadcrumb link)
const sectionFirstDoc = projectDocs.find((d) => d.section === activeDoc.section);
---

<BaseLayout title={`${activeDoc.title} — ${project} Docs`} fullHeight>
  <div class="docs-reader">
    <!-- Left sidebar -->
    <aside class="sidebar">
      <a href="/docs" class="back-link">← Tous les projets</a>
      <div class="sidebar-search">
        <DocSearch client:visible />
      </div>
      <h3 class="sidebar-title">{project}</h3>
      {orderedSections.map((s) => (
        <div class="sidebar-section">
          <h4 class="section-title">{s.title}</h4>
          {s.items.map((item) => (
            <a
              href={`/docs/${project}/${item.id}`}
              class:list={["sidebar-item", { active: item.id === activeDoc.id, hidden: !item.visible }]}
            >
              {item.title}
              {!item.visible && <span class="hidden-dot">●</span>}
            </a>
          ))}
        </div>
      ))}
    </aside>

    <!-- Main content -->
    <main class="doc-content">
      <div class="breadcrumb">
        <a href={`/docs/${project}`} class="bc-item bc-link">{project}</a>
        <span class="bc-sep">›</span>
        <a href={`/docs/${project}/${sectionFirstDoc?.id ?? pageSlug}`} class="bc-item bc-link">{activeDoc.section}</a>
        <span class="bc-sep">›</span>
        <span class="bc-item bc-active">{activeDoc.title}</span>
      </div>
      <h1 class="doc-title">{activeDoc.title}<span class="dot">.</span></h1>
      <div class="md-body" set:html={contentHtml} />
      {isAdmin && (
        <AdminBar
          hasDraft={!!activeDoc.draft}
          publishUrl={`/api/docs/${activeDoc.id}/publish`}
        />
      )}
    </main>

    <!-- Right TOC -->
    <aside class="toc-sidebar">
      <h4 class="toc-title">Sur cette page</h4>
      {toc.map((t, i) => (
        <a href={`#${t.slug}`} class:list={["toc-item", { active: i === 0 }]}>{t.text}</a>
      ))}
    </aside>
  </div>
  {isAdmin && <EditButton href={`/admin/docs-edit?id=${activeDoc.id}`} />}
  <MermaidInit />
</BaseLayout>

<style>
  .docs-reader {
    display: grid;
    grid-template-columns: 250px 1fr 170px;
    flex: 1;
    overflow: hidden;
  }

  /* ─── Left sidebar ─── */
  .sidebar {
    padding: 1.5rem 1.2rem;
    border-right: 1px solid var(--line);
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }

  .back-link {
    background: none;
    border: none;
    color: var(--tertiary);
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.78rem;
    margin-bottom: 1rem;
    text-align: left;
    padding: 0;
    text-decoration: none;
    transition: color 0.2s;
  }

  .back-link:hover {
    color: var(--blue-hover);
  }

  .sidebar-search {
    margin-bottom: 1rem;
  }

  .sidebar-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--white);
    margin-bottom: 1rem;
  }

  .sidebar-section {
    margin-bottom: 1.5rem;
  }

  .section-title {
    font-family: 'Playfair Display', serif;
    font-size: 0.85rem;
    color: var(--white);
    margin-bottom: 0.5rem;
    font-weight: 600;
  }

  .sidebar-item {
    display: block;
    padding: 0.3rem 0;
    padding-left: 0.8rem;
    cursor: pointer;
    font-size: 0.85rem;
    font-family: 'DM Sans', sans-serif;
    color: var(--tertiary);
    font-weight: 400;
    border-left: 2px solid transparent;
    transition: color 0.2s, border-color 0.2s;
    text-decoration: none;
  }

  .sidebar-item:hover {
    color: var(--blue-hover);
  }

  .sidebar-item.active {
    color: var(--blue-hover);
    font-weight: 500;
    border-left-color: var(--blue);
  }

  .sidebar-item.hidden {
    color: var(--decorative);
    font-style: italic;
  }

  .hidden-dot {
    font-size: 0.5rem;
    color: var(--tertiary);
    margin-left: 0.3rem;
    vertical-align: middle;
  }

  /* ─── Main content ─── */
  .doc-content {
    padding: 3rem 3.5rem 6rem;
    overflow-y: auto;
  }

  .breadcrumb {
    display: flex;
    gap: 0.3rem;
    margin-bottom: 2.5rem;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.8rem;
  }

  .bc-item {
    color: var(--tertiary);
  }

  .bc-link {
    text-decoration: none;
    transition: color 0.2s;
  }

  .bc-link:hover {
    color: var(--blue-hover);
  }

  .bc-active {
    color: var(--blue-hover);
  }

  .bc-sep {
    color: var(--line);
    margin: 0 0.4rem;
  }

  .doc-title {
    font-family: 'Playfair Display', serif;
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 2rem;
    color: var(--white);
  }

  .dot {
    color: var(--blue);
  }

  /* ─── Right TOC ─── */
  .toc-sidebar {
    border-left: 1px solid var(--line);
    padding: 3rem 1.2rem;
    overflow-y: auto;
  }

  .toc-title {
    font-family: 'DM Sans', sans-serif;
    font-size: 0.7rem;
    color: var(--tertiary);
    letter-spacing: 1.5px;
    margin-bottom: 1rem;
    text-transform: uppercase;
    font-weight: 500;
  }

  .toc-item {
    display: block;
    font-size: 0.85rem;
    color: var(--tertiary);
    margin-bottom: 0.6rem;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    padding-left: 0.8rem;
    border-left: 1px solid transparent;
    text-decoration: none;
    transition: color 0.2s;
  }

  .toc-item:hover {
    color: var(--blue-hover);
  }

  .toc-item.active {
    color: var(--blue-hover);
    border-left-color: var(--blue);
  }

  /* md-body styles are in global.css — only override font-size for docs */
  .md-body {
    font-size: 0.95rem;
  }
</style>