---
import BaseLayout from "../../layouts/BaseLayout.astro";
import DocSearch from "../../components/DocSearch";
import { db } from "../../db";
import { docs, sections, projects as projectsTable } from "../../db/schema";
import { eq } from "drizzle-orm";

// Get all visible projects with stats
const allProjects = await db.select().from(projectsTable).where(eq(projectsTable.visible, true)).orderBy(projectsTable.sortOrder).all();

const projectStats = await Promise.all(
  allProjects.map(async (proj) => {
    const projDocs = await db
      .select({ id: docs.id, sectionId: docs.sectionId })
      .from(docs)
      .innerJoin(sections, eq(docs.sectionId, sections.id))
      .where(eq(sections.projectId, proj.id))
      .all();
    const visibleDocs = projDocs;
    const sectionSet = new Set(visibleDocs.map((d) => d.sectionId));
    return {
      name: proj.name,
      count: visibleDocs.length,
      sectionCount: sectionSet.size,
      firstId: visibleDocs[0]?.id,
    };
  }),
);

const projectsList = projectStats.filter((p) => p.firstId);
---

<BaseLayout title="Documentation — Gabriel Guillou">
  <div class="docs-selector">
    <h1 class="docs-title">Documentation<span class="dot">.</span></h1>
    <p class="docs-subtitle">Sélectionnez un projet pour accéder à sa documentation.</p>

    <div class="docs-search">
      <DocSearch client:visible />
    </div>

    <div class="project-grid">
      {projectsList.map((proj) => (
        <a href={`/docs/${proj.name}/${proj.firstId}`} class="project-card">
          <h3 class="project-name">{proj.name}</h3>
          <p class="project-info">{proj.count} pages · {proj.sectionCount} sections</p>
        </a>
      ))}
    </div>
  </div>
</BaseLayout>

<style>
  .docs-selector {
    max-width: 1100px;
    width: 100%;
    margin: 0 auto;
    padding: 6rem 3rem 8rem;
  }

  .docs-title {
    font-family: 'Playfair Display', serif;
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    color: var(--white);
  }

  .dot {
    color: var(--blue);
  }

  .docs-subtitle {
    font-family: 'DM Sans', sans-serif;
    color: var(--secondary);
    font-size: 1rem;
    margin-bottom: 3rem;
  }

  .docs-search {
    max-width: 360px;
    margin-bottom: 2.5rem;
  }

  .project-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 1.5rem;
  }

  .project-card {
    padding: 1.5rem;
    border: 1px solid var(--line);
    border-radius: 8px;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    text-decoration: none;
  }

  .project-card:hover {
    border-color: color-mix(in srgb, var(--blue) 27%, transparent);
    background: color-mix(in srgb, var(--blue) 3%, transparent);
  }

  .project-name {
    font-family: 'Playfair Display', serif;
    font-size: 1.4rem;
    font-weight: 600;
    color: var(--white);
    margin-bottom: 0.4rem;
  }

  .project-info {
    font-family: 'DM Sans', sans-serif;
    font-size: 0.8rem;
    color: var(--tertiary);
  }

  /* ─── Tablet ─── */
  @media (max-width: 1024px) {
    .docs-selector {
      padding: 4rem 1.5rem 6rem;
    }
  }

  /* ─── Mobile ─── */
  @media (max-width: 768px) {
    .docs-selector {
      padding: 3rem 1.2rem 4rem;
    }

    .docs-title {
      font-size: 2rem;
    }

    .project-grid {
      grid-template-columns: 1fr;
    }
  }
</style>