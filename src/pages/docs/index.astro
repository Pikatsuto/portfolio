---
import BaseLayout from "../../layouts/BaseLayout.astro";
import DocSearch from "../../components/DocSearch";
import { db } from "../../db";
import { docs } from "../../db/schema";
import { eq } from "drizzle-orm";

const allDocs = await db
  .select()
  .from(docs)
  .where(eq(docs.visible, true))
  .all();

// Derive unique projects and their stats
const projectMap = new Map<string, { count: number; sections: Set<string>; firstId: string }>();
for (const d of allDocs) {
  const entry = projectMap.get(d.project);
  if (entry) {
    entry.count++;
    entry.sections.add(d.section);
  } else {
    projectMap.set(d.project, { count: 1, sections: new Set([d.section]), firstId: d.id });
  }
}

const projects = Array.from(projectMap.entries()).map(([name, info]) => ({
  name,
  count: info.count,
  sectionCount: info.sections.size,
  firstId: info.firstId,
}));
---

<BaseLayout title="Documentation — Gabriel">
  <div class="docs-selector">
    <h1 class="docs-title">Documentation<span class="dot">.</span></h1>
    <p class="docs-subtitle">Sélectionnez un projet pour accéder à sa documentation.</p>

    <div class="docs-search">
      <DocSearch client:visible />
    </div>

    <div class="project-grid">
      {projects.map((proj) => (
        <a href={`/docs/${proj.name}/${proj.firstId}`} class="project-card">
          <h3 class="project-name">{proj.name}</h3>
          <p class="project-info">{proj.count} pages · {proj.sectionCount} sections</p>
        </a>
      ))}
    </div>
  </div>
</BaseLayout>

<style>
  .docs-selector {
    max-width: 1100px;
    width: 100%;
    margin: 0 auto;
    padding: 6rem 3rem 8rem;
  }

  .docs-title {
    font-family: 'Playfair Display', serif;
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    color: var(--white);
  }

  .dot {
    color: var(--blue);
  }

  .docs-subtitle {
    font-family: 'DM Sans', sans-serif;
    color: var(--secondary);
    font-size: 1rem;
    margin-bottom: 3rem;
  }

  .docs-search {
    max-width: 360px;
    margin-bottom: 2.5rem;
  }

  .project-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 1.5rem;
  }

  .project-card {
    padding: 1.5rem;
    border: 1px solid var(--line);
    border-radius: 8px;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    text-decoration: none;
  }

  .project-card:hover {
    border-color: color-mix(in srgb, var(--blue) 27%, transparent);
    background: color-mix(in srgb, var(--blue) 3%, transparent);
  }

  .project-name {
    font-family: 'Playfair Display', serif;
    font-size: 1.4rem;
    font-weight: 600;
    color: var(--white);
    margin-bottom: 0.4rem;
  }

  .project-info {
    font-family: 'DM Sans', sans-serif;
    font-size: 0.8rem;
    color: var(--tertiary);
  }
</style>